---
title: "Create testdata"
author: "Eva Marques"
date: "2024-06-05"
output: html_document
---

Configuration

```{r}
triangle <- rbind(c(-79.19,35.6),
                  c(-79.19, 36.11),
                  c(-78.39, 36.11),
                  c(-78.39, 35.6)) |>
  terra::vect("polygons", crs = "epsg:4326")
```

Open WU inventory and randomly select 150 stations

```{r}
inv <- "../../input/weatherunderground/Raleigh_Stations_inventory.csv" |>
  read.csv() |>
  sf::st_as_sf(coords = c("lon", "lat"), crs = 4326, remove = FALSE)
inv$ts_utc <- as.POSIXct(inv$ts_utc,
                         format = "%Y-%m-%d %H:%M:%S",
                         tz = "UTC")
inv$te_utc <- as.POSIXct(inv$te_utc,
                         format = "%Y-%m-%d %H:%M:%S",
                         tz = "UTC")
samp <- sample(seq(1, nrow(inv), 1), size = 150, replace = FALSE)
inv <- inv[samp, ]
```


```{r}
config <- list(
  ts = as.POSIXct("2021-07-20 00:00:00", tz = "America/New_York"),
  te = as.POSIXct("2021-07-27 23:59:59", tz = "America/New_York"),
  area = triangle,
  wu_inv = inv
)
```

Weather Underground testdata

```{r}
setwd("../..")
wu <- load_wu(config$ts, config$te, config$area, config$wu_inv)
keep <- c("stationID",
          "timezone",
          "obsTimeUtc",
          "lat",
          "lon",
          "humidityAvg",
          "tempAvg")
wu <- wu[, ..keep]
```

Create simulated dataset from raw wu

```{r}
set.seed(123)
# replace stationID
id <- data.table(stationID = unique(wu$stationID),
                 lon = unique(wu$lon),
                 lat = unique(wu$lat),
                 new = as.character(1:length(unique(wu$stationID))))
# add noise to lat and lon
id$lat <- id$lat + rnorm(nrow(id), 0, 0.005)
id$lon <- id$lon + rnorm(nrow(id), 0, 0.005)
wu_sim <- merge(wu[, c("stationID",
                       "timezone",
                       "obsTimeUtc",
                       "humidityAvg",
                       "tempAvg")],
                id,
                by = "stationID")
wu_sim$new <- NULL
lubridate::second(wu_sim$obsTimeUtc) <- sample(0:59,
                                               nrow(wu_sim),
                                               replace = TRUE)
lubridate::minute(wu_sim$obsTimeUtc) <- sample(0:59,
                                               nrow(wu_sim),
                                               replace = TRUE)
wu_sim$humidityAvg <- wu_sim$humidityAvg + sample(-5:5,
                                                  nrow(wu_sim),
                                                  replace = TRUE)
wu_sim$tempAvg <- wu_sim$tempAvg + sample(-5:5,
                                          nrow(wu_sim),
                                          replace = TRUE)
saveRDS(wu_sim, "wu_raw_simulated_testdata.rds")
```



PurpleAir testdata

```{r}
set.seed(123)
pa_file <- "../../input/rtp/pa_20210720_20210727.csv"
pa <- load_pa(config$ts, config$te, config$area, storage_file = pa_file)
head(pa)
id <- data.table(sensor_index = unique(pa$sensor_index),
                 longitude = unique(pa$longitude),
                 latitude = unique(pa$latitude),
                 new = as.character(1:length(unique(pa$sensor_index))))
# add noise to latitude and longitude
id$latitude <- id$latitude + rnorm(nrow(id), 0, 0.005)
id$longitude <- id$longitude + rnorm(nrow(id), 0, 0.005)
pa_sim <- merge(pa[, c("sensor_index",
                       "time_stamp",
                       "humidity",
                       "temperature")],
                id,
                by = "sensor_index")
pa_sim$new <- NULL
pa_sim$humidity <- pa_sim$humidity + sample(-5:5,
                                                  nrow(pa_sim),
                                                  replace = TRUE)
pa_sim$temperature <- pa_sim$temperature + sample(-5:5,
                                          nrow(pa_sim),
                                          replace = TRUE)      
saveRDS(pa_sim, "pa_raw_simulated_testdata.rds")
```


GHCNh testdata

```{r}
ghcnh <- download_ghcnh(config$ts, config$te, config$area)
saveRDS(ghcnh, "ghcnh_testdata.rds")
```

